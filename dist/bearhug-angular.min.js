!function(){angular.module("talis.bearhug",[]),angular.module("talis.bearhug").factory("bearerUtils",function(){function a(a){var b=angular.isString(a)&&a.match(c);return angular.isArray(b)&&b[1]?b[1]:void 0}function b(a){return angular.isString(a)?"Bearer "+a:void 0}var c=/^Bearer (.*)$/;return{bearer2token:a,token2bearer:b}}),angular.module("talis.bearhug").config(["$httpProvider",function(a){a.interceptors.push("bearhugInterceptor")}]),angular.module("talis.bearhug").provider("bearhug",function(){var a={auth:{endpoint:"http://persona.staging/2/auth/providers/google/login.json?cb=JSON_CALLBACK",httpMethod:"JSONP",transformResponse:function(a){return a&&a.data&&a.data.oauth&&a.data.oauth.access_token||void 0}},onError:console.error,onLog:console.log};this.setCreateEndpointFunc=function(b){a.getEndpoint=b},this.setOnError=function(b){a.onError=b},this.setOnLog=function(b){a.onLog=b},this.setAuthEndpoint=function(b){a.auth.endpoint=angular.isString(b)?b:a.auth.endpoint},this.$get=["$injector","bearhugAuthenticator","bearhugStorage",function(b,c,d){function e(a){return c.authenticate(f.auth,a)}var f=angular.copy(a);return{options:f,authenticate:e,getToken:d.getToken,getBearer:d.getBearer,getUser:d.getUser,getHasRetried:function(){throw new Error("getHasRetried should never be called")},log:function(a){b.invoke(f.onLog,this,{info:a})},error:function(a){b.invoke(f.onError,this,{err:a})}}}]}),angular.module("talis.bearhug").factory("bearhugAuthenticator",["$http","$q","bearhugStorage",function(a,b,c){function d(d){var g=angular.extend({},f,d),h=a[g.httpMethod&&g.httpMethod.toLowerCase()];if(angular.isString(g.endpoint)){if(angular.isFunction(h)){if(e)return e.promise;e=b.defer();h(g.endpoint).then(function(a){var b=a&&a.data,d=angular.isFunction(g.transformResponse)?g.transformResponse(b):b;c.setToken(d),e.resolve(c.getToken())})["catch"](e.reject);return e.promise}return b.reject(new Error("authenticate.httpMethod is invalid:",g.httpMethod))}return b.reject(new Error("authenticate.endpoint is not a valid string:",g.endpoint))}var e,f={endpoint:null,httpMethod:null,transformResponse:null};return{authenticate:d}}]),angular.module("talis.bearhug").factory("bearhugInterceptor",["$q","$injector","bearhugStorage",function(a,b,c){function d(a){var b=c.getBearer();return b&&a&&a.headers&&(a.headers.Authorization=b),a}function e(a){var b=a&&a.headers("Authorization");return b&&c.setBearer(b),a}function f(c){var d=b.get("$http"),e=b.get("bearhug");return c&&c.status&&c.config?401!==c.status?a.reject(c):g(e,c.config)?a.reject(c):e.authenticate(c.config).then(function(){return d(c.config)})["catch"](function(b){return a.reject(c)}):a.reject(c)}function g(a,b){var c=a.options.auth;return b.url===c.endpoint&&b.method===c.httpMethod}return{request:d,response:e,responseError:f}}]),angular.module("talis.bearhug").factory("bearhugStorage",["bearerUtils",function(a){function b(){return f||null}function c(a){f=a?a:f}function d(){return a.token2bearer(b())||null}function e(b){var d=a.bearer2token(b);c(d)}var f=null;return{getToken:b,setToken:c,getBearer:d,setBearer:e}}])}();